<link rel="import" href="../../../bower_components/polymer/polymer.html">
<link rel="import" href="../../../bower_components/vaadin-material-theme/vaadin-grid.html">
<link rel="import" href="../../../bower_components/vaadin-grid/vaadin-grid.html">
<link rel="import" href="../../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../../bower_components/paper-radio-group/paper-radio-group.html">
<link rel="import" href="../../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../../bower_components/tk-token-field/tk-token-field.html">
<link rel="import" href="../../../bower_components/vaadin-themes/material/vaadin-date-picker.html">
<link rel="import" href="../../vaadin-icure-theme.html">
<link rel="import" href="../../../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../../dialog-style.html">
<link rel="import" href="../../scrollbar-style.html">

<dom-module id="health-problem-selector">
	<template>
		<style include="dialog-style scrollbar-style">
			paper-dialog {
				width: 60%;
				height: 80%;
				max-width: 1024px;
				max-height:690px;
			}


			paper-input{
				--paper-input-container-focus-color: var(--app-primary-color);
			}

			dom-if {
				padding: 0;
			}

            vaadin-combo-box  {
                width: calc( 100% - 48px );
                margin:8px 0;
            }

			.flex{
				display: flex;
				flex-flow: row wrap;
				justify-content: flex-start;
				align-items: center;
				margin-top: 8px;
			}

			.label{
                background: var(--app-background-color-dark);
                color: var(--app-primary-color-dark);
                --paper-item-min-height: 28px;
                width: 120px;
                font-size: 12px;
                padding: 0 0 0 8px;
				justify-content: space-between;
			}

            paper-radio-group{
                --paper-radio-group-item-padding: 8px;
            }

			paper-radio-button{
				--paper-radio-button-checked-color: var(--app-secondary-color-dark);
				min-width: 110px;
				max-width: 110px;
				text-overflow: ellipsis;
				white-space: nowrap;
			}

			paper-radio-button:nth-child(4){
				max-width: 130px;
				min-width: 130px;
			}

			paper-radio-button:last-child{
				min-width: 130px;
				max-width: 200px;
			}

			vaadin-date-picker {
				height: 56px;
			}

			tk-token-field {
				top: -16px;
			}

			.content {
				position: relative;
			}

            .modal-button--cancel {
                background: transparent;
                color: black;
                border: 1px solid var(--app-background-color-dark);
            }

		</style>

		<paper-dialog id="dialog">
			<h2 class="modal-title">[[okLabel]] [[entityType]]</h2>
			<div class="content">
				<div class="flex">
					<paper-item class="label">[[localize('nat','Nature',language)]]<iron-icon icon="icons:chevron-right"></iron-icon></paper-item>
					<paper-radio-group selected="[[_nature(entity, entity.tags, entity.tags.*)]]" on-selected-changed="_natureChanged">
						<paper-radio-button name="healthcareelement">[[localize('healthcareelement','Problem',language)]]</paper-radio-button>
						<paper-radio-button name="familyrisk">[[localize('familyrisk','Family Risk',language)]]</paper-radio-button>
						<paper-radio-button name="risk">[[localize('risk','Risk',language)]]</paper-radio-button>
						<paper-radio-button name="socialrisk">[[localize('socialrisk','Social risk',language)]]</paper-radio-button>
						<paper-radio-button name="allergy">[[localize('allergy','Allergy',language)]]</paper-radio-button>
						<paper-radio-button name="adr">[[localize('adr','Adverse drug reaction',language)]]</paper-radio-button>
						<paper-radio-button name="surgery">[[localize('surg_abr','Surgery',language)]]</paper-radio-button>
					</paper-radio-group>
				</div>
				<div class="flex">
					<template is="dom-if" if="[[!searchSurgery]]">
						<vaadin-combo-box id="entities-list" filtered-items="[[items]]" on-filter-changed="_filterChanged" item-label-path="descr" selected-item="{{selectedItem}}" item-value-path="id" label="[[localize('sea_for_hea_ele','Search for health element',language)]]"></vaadin-combo-box>
						<template is="dom-if" if="[[searchAllergen]]">
							<vaadin-combo-box id="entities-list" filtered-items="[[allergenItems]]" on-filter-changed="_allergenFilterChanged" item-label-path="descr" selected-item="{{allergenSelectedItem}}" item-value-path="id" label="[[localize('sea_for_alle','Search for allergens',language)]]"></vaadin-combo-box>
						</template>
						<template is="dom-if" if="[[searchDrug]]">
							<vaadin-combo-box id="entities-list" filtered-items="[[drugItems]]" on-filter-changed="_drugFilterChanged" item-label-path="name" selected-item="{{drugSelectedItem}}" item-value-path="id.id" label="[[localize('sea_for_dru','Search for drugs',language)]]"></vaadin-combo-box>
						</template>
						<template is="dom-if" if="[[searchFamilyLink]]">
							<vaadin-combo-box id="entities-list" filtered-items="[[familyLinkItems]]" on-filter-changed="_familyRiskFilterChanged" item-label-path="descr" selected-item="{{familyRiskSelectedItem}}" item-value-path="id" label="[[localize('sea_for_fam_link','Search for family link',language)]]"></vaadin-combo-box>
						</template>
					</template>
					<template is="dom-if" if="[[searchSurgery]]">
						<vaadin-combo-box id="entities-list" filtered-items="[[surgeryItems]]" on-filter-changed="_surgeryFilterChanged" item-label-path="descr" selected-item="{{surgerySelectedItem}}" item-value-path="id" label="[[localize('sea_for_surgery','Search for surgery',language)]]"></vaadin-combo-box>
					</template>
				</div>
				<div class="flex">
					<paper-item class="label">[[localize('sta','Status',language)]]<iron-icon icon="icons:chevron-right"></iron-icon></paper-item>
					<paper-radio-group selected="[[_status(entity, entity.tags, entity.tags.*, entity.status, entity.closingDate)]]" on-selected-changed="_statusChanged">
						<paper-radio-button name="active-relevant">[[localize('act_rel','Active relevant',language)]]</paper-radio-button>
						<paper-radio-button name="active-irrelevant">[[localize('act_irr','Active irrelevant',language)]]</paper-radio-button>
						<paper-radio-button name="inactive">[[localize('ina','Inactive',language)]]</paper-radio-button>
						<paper-radio-button name="archived">[[localize('archiv','Archived',language)]]</paper-radio-button>
					</paper-radio-group>
				</div>
				<div class="flex">
					<paper-item class="label">[[localize('cert','Certainty',language)]]<iron-icon icon="icons:chevron-right"></iron-icon></paper-item>
					<paper-radio-group selected="[[_certainty(entity, entity.tags, entity.tags.*, entity.status, entity.closingDate)]]" on-selected-changed="_certaintyChanged">
						<paper-radio-button name="proven">[[localize('proven','Proven',language)]]</paper-radio-button>
						<paper-radio-button name="probable">[[localize('probable','Probable',language)]]</paper-radio-button>
						<paper-radio-button name="unprobable">[[localize('unprobable','improbable',language)]]</paper-radio-button>
						<paper-radio-button name="excluded">[[localize('excluded','Excluded',language)]]</paper-radio-button>
					</paper-radio-group>
				</div>
				<div class="flex">
					<paper-item class="label">[[localize('sev','Severity',language)]]<iron-icon icon="icons:chevron-right"></iron-icon></paper-item>
					<paper-radio-group selected="[[_severity(entity, entity.tags, entity.tags.*, entity.status, entity.closingDate)]]" on-selected-changed="_severityChanged">
						<paper-radio-button name="normal">[[localize('normal','No problem',language)]]</paper-radio-button>
						<paper-radio-button name="verylow">[[localize('verylow','Light',language)]]</paper-radio-button>
						<paper-radio-button name="low">[[localize('low','Moderate',language)]]</paper-radio-button>
						<paper-radio-button name="high">[[localize('high','Severe',language)]]</paper-radio-button>
						<paper-radio-button name="veryhigh">[[localize('veryhigh','Total',language)]]</paper-radio-button>
					</paper-radio-group>
				</div>
				<div class="flex">
					<paper-item class="label">[[localize('ext_temp','Extra temporality',language)]]<iron-icon icon="icons:chevron-right"></iron-icon></paper-item>
					<paper-radio-group selected="[[_extraTemporality(entity, entity.tags, entity.tags.*, entity.status, entity.closingDate)]]" on-selected-changed="_extraTemporalityChanged">
						<!--<paper-radio-button name="chronic">[[localize('chronic','Chronic',language)]]</paper-radio-button>
						<paper-radio-button name="subbacute">[[localize('subbacute','Sub-acute',language)]]</paper-radio-button>
						<paper-radio-button name="acute">[[localize('acute','Acute',language)]]</paper-radio-button>-->
						<paper-radio-button name="remission">[[localize('remission','Remission',language)]]</paper-radio-button>
						<paper-radio-button name="relapse">[[localize('relapse','Relapse',language)]]</paper-radio-button>
					</paper-radio-group>
				</div>

				<paper-input label="[[localize('lab','Label',language)]]" value="{{entity.descr}}"></paper-input>

				<div class="flex">
					<vaadin-date-picker label="[[localize('st_da','Start Date',language)]]" i18n="[[i18n]]" value="{{_openingDateAsString}}"></vaadin-date-picker>
					<vaadin-date-picker label="[[localize('en_da','End Date',language)]]" i18n="[[i18n]]" value="{{_closingDateAsString}}"></vaadin-date-picker>

					<paper-dropdown-menu id="temporality" label="[[localize('temp','Temporality',language)]]">
						<paper-listbox slot="dropdown-content" class="dropdown-temporality" selected={{temporalityItemIdx}} selected-item="{{temporalityItem}}">
							<template is="dom-repeat" items="[[temporalityList]]" as="tp">
								<paper-item id="[[tp.code]]">[[_getTpLabel(tp)]]</paper-item>
							</template>
						</paper-listbox>
					</paper-dropdown-menu>
				</div>

				<tk-token-field label="[[localize('co','Code',language)]]" value="{{entity.codes}}" data-value-path="id"  label-path="[[_label(language)]]" data-label-path="[[_label(language)]]" always-float-label></tk-token-field>
				<tk-token-field label="[[localize('pl_of_ac','Plans of action',language)]]" value="{{entity.plansOfAction}}" data-value-path="id"  data-label-path="descr" always-float-label></tk-token-field>

				<slot name="suffix"></slot>
			</div>
			<div class="buttons">
				<paper-button class="modal-button--cancel" dialog-dismiss>[[localize('can','Cancel',language)]]</paper-button>
				<template is="dom-if" if="[[isValid]]">
					<paper-button class="modal-button--save" dialog-confirm autofocus on-tap="confirm">[[okLabel]]</paper-button>
				</template>
			</div>
		</paper-dialog>

	</template>
	<script>

import _ from 'lodash/lodash';
import moment from 'moment/src/moment';

class HealthProblemSelector extends Polymer.TkLocalizerMixin(Polymer.Element) {
	static get is() {
		return 'health-problem-selector';
	}

	static get properties() {
		return {
			columns: {
				type: Array,
				value: function () {
					return [];
				}
			},

			entityType: {
				type: String,
				value: 'entity'
			},

			entity: {
				type: Object,
				value: () => ({ plansOfAction: [] }),
				notify: true
			},

			okLabel: {
				type: String
			},

			filterValue: {
				type: String
			},

			dataProvider: {
				type: Object,
				value: null
			},

            allergenDataProvider:{
                type: Object,
                value: null
			},

			i18n: {
				type: Object
			},

			selectedItem: {
				type: Object,
				value: null
			},
            surgerySelectedItem:{
                type: Object,
                value: null
			},
            allergenSelectedItem: {
                type: Object,
                value: null
			},
			drugSelectedItem: {
				type: Object,
				value: null
			},
            familyRiskSelectedItem:{
                type: Object,
                value: null
			},
			items: {
				type: Array,
				value: () => []
			},
            allergenItems: {
                type: Array,
                value: () => []
			},
            familyLinkItems: {
			  type: Array,
				value:  () => []
			},
			_openingDateAsString: {
				type: String
			},
			_closingDateAsString: {
				type: String
			},
            searchAllergen:{
                type: Boolean,
                value: false
			},
			searchDrug:{
				type: Boolean,
				value: false
			},
            searchFamilyLink:{
                type: Boolean,
                value: false
			},
            allergenFilterValue: {
			    type: String
			},
 			drugFilterValue: {
				type: String
			},
            familyLinkFilterValue: {
                type: String
            },
			searchSurgery: {
			    type: Boolean,
				value: false
			},
            surgeryItems:{
                type: Array,
                value:  () => []
			},
			surgeryFilterValue: {
                type: String
            },
            temporalityItemIdx: {
                type: Number,
                value: 0
			},
			temporalityList:{
			    type: Array,
				value: () => []
			},
            temporalityItem:{
			    type: Object,
				value: () => {}
			},
            isValid: {
			    type : Boolean,
				value : false
			}
		};
	}

	static get observers() {
		return ['_selectedTemporalityItemChanged(temporalityItem)','_filterChanged(filterValue)', '_selectedItemChanged(selectedItem)', '_selectSurgerySelectedItem(surgerySelectedItem)', '_updateDescription(selectedItem, allergenSelectedItem, familyRiskSelectedItem, surgerySelectedItem, drugSelectedItem)', '_ehDateChanged(entity.openingDate, entity.closingDate)','_openingDateChanged(entity.openingDate)', '_closingDateChanged(entity.closingDate)', '_openingDateAsStringChanged(_openingDateAsString)', '_closingDateAsStringChanged(_closingDateAsString)','_checkValidity(entity.codes)'];
	}

	constructor() {
		super();
	}

	_filterChanged(e) {
		let latestSearchValue = this.filterValue || e && e.detail.value;
		this.latestSearchValue = latestSearchValue;

		if (!latestSearchValue || latestSearchValue.length < 2) {
			console.log("Cancelling empty search");
			this.set('items', []);
			return;
		}

		this.dataProvider && this.dataProvider.filter(latestSearchValue, 500, 0, 'descr', false).then(res => {
			if (latestSearchValue !== this.latestSearchValue) {
				console.log("Cancelling obsolete search");
				return;
			}
			this.set('items', res.rows);
		});
	}

	_updateDescription() {
        if (this.selectedItem || this.surgerySelectedItem) {
            this.set('entity.descr', (this.searchAllergen && this.allergenSelectedItem) ? `${this.selectedItem.descr} (${this.allergenSelectedItem.descr})` : (this.searchFamilyRisk && this.familyRiskSelectedItem) ? `${this.selectedItem.descr} (${this.familyRiskSelectedItem.descr})` : (this.searchDrug && this.drugSelectedItem) ? `${this.selectedItem.descr} (${this.drugSelectedItem.name})` : (this.searchSurgery && this.surgerySelectedItem) ? `${this.surgerySelectedItem.descr}` : this.selectedItem.descr);
        }
    }

	_selectedItemChanged() {
		if (this.selectedItem) {
			this.set('entity.plansOfAction', this.selectedItem.plansOfAction || []);
			this.api.code().getCodes(this.selectedItem.codes.join(',')).then(codes => {
				this.set('entity.codes', codes);
			});
		}
	}

    _selectSurgerySelectedItem(){
        if (this.surgerySelectedItem) {
            this.set('entity.plansOfAction', this.surgerySelectedItem.plansOfAction || []);
            this.api.code().getCodes(this.surgerySelectedItem.codes.join(',')).then(codes => {
                this.set('entity.codes', codes);
            });
        }
	}


    _allergenFilterChanged(e){

        let latestSearchValue = e && e.detail.value;
        this.latestSearchValue = latestSearchValue;
        if (!latestSearchValue || latestSearchValue.length < 2) {
            console.log("Cancelling empty search");
            this.set('allergenItems', []);
            return;
        }
        this.dataProvider && this.dataProvider.filter(latestSearchValue, 500, 0, 'descr', false, ['BE-ALLERGEN','CD-ATC']).then(res => {
            if (latestSearchValue !== this.latestSearchValue) {
                console.log("Cancelling obsolete search");
                return;
            }
            this.set('allergenItems', res.rows);
        });
	}

	_drugFilterChanged(e) {
		let latestSearchValue = e && e.detail.value;
		this.latestSearchValue = latestSearchValue;
		if (!latestSearchValue || latestSearchValue.length < 2) {
			console.log("Cancelling empty search");
			this.set('drugItems', []);
			return;
		}


		const search = this.dataProvider && (() => this.dataProvider.filterDrugs(latestSearchValue, 500, 0, 'name', false))

		if(this.drugFilterTimeout) {
			clearTimeout(this.drugFilterTimeout)
		}

		this.drugFilterTimeout = setTimeout(() => search().then(res => {
			if (latestSearchValue !== this.latestSearchValue) {
				console.log("Cancelling obsolete search");
				return;
			}

			this.drugFilterTimeout = null
			this.set('drugItems', res.rows);
		}), 500)

	}

    _familyRiskFilterChanged(e){
        let latestSearchValue = e && e.detail.value;
        this.latestSearchValue = latestSearchValue;
        if (!latestSearchValue || latestSearchValue.length < 2) {
            console.log("Cancelling empty search");
            this.set('familyLinkItems', []);
            return;
        }
        this.dataProvider && this.dataProvider.filter(latestSearchValue, 500, 0, 'descr', false, ['BE-FAMILY-LINK']).then(res => {
            if (latestSearchValue !== this.latestSearchValue) {
                console.log("Cancelling obsolete search");
                return;
            }
            this.set('familyLinkItems', res.rows);
        });
	}

    _surgeryFilterChanged(e){
        let latestSearchValue = e && e.detail.value;
        this.latestSearchValue = latestSearchValue;
        if (!latestSearchValue || latestSearchValue.length < 2) {
            console.log("Cancelling empty search");
            this.set('surgeryItems', []);
            return;
        }
        this.dataProvider && this.dataProvider.filter(latestSearchValue, 500, 0, 'descr', false, ['BE-THESAURUS-SURGICAL-PROCEDURES']).then(res => {
            if (latestSearchValue !== this.latestSearchValue) {
                console.log("Cancelling obsolete search");
                return;
            }
            this.set('surgeryItems', res.rows);
        });
	}

	_tagForEntity(e, type, code) {
		const tags = e && (e.tags || (e.tags = []));
		return tags.find(t => t.type === type) || create && (tags[tags.length] = { type: type, code: code, version: '1' });
	}

    _cdItemTagForEntity(e, create) {
        return this._tagForEntity(e , 'CD-ITEM', create && 'healthcareelement');
    }

    _nature() {
        const code = this._cdItemTagForEntity(this.entity, true);
        return code && code.code;
    }

    _status() {
		//possible returns
		//entity === null --> null
		//status & 3 === 3 -- x11 --> 'archived' !!! not 2
		//status & 2 === 2 -- x10 --> 'active-irrelevant'
		// && if closingdate before now -- x11 --> 'archived'
		//status & 1 === 1 -- x01 --> 'inactive'
		//status & 3 === 0 -- x00 --> 'active-relevant'
		// && if closingdate before now -- x01 --> 'inactive'
        return !this.entity ? null :
				((this.entity.status || 0) & 3) === 3 ? 'archived' :
						((this.entity.status || 0) & 2) === 2 && (this.entity.closingDate && this.api.moment(this.entity.closingDate).isBefore()) ? 'archived' :
								((this.entity.status || 0) & 2) === 2 ? 'active-irrelevant' :
										((this.entity.status || 0) & 1) === 1 ? 'inactive' :
												((this.entity.status || 0) & 3) === 0 && (this.entity.closingDate && this.api.moment(this.entity.closingDate).isBefore()) ? 'inactive' :
								'active-relevant';
    }

    _severity() {
        const code = this._tagForEntity(this.entity, 'CD-SEVERITY');
        return code && code.code;
    }

    _extraTemporality() {
        const code = this._tagForEntity(this.entity, 'CD-EXTRA-TEMPORALITY');
        return code && code.code;
    }

    _certainty() {
        const code = this._tagForEntity(this.entity, 'CD-CERTAINTY');
        return code && code.code;
    }

	_natureChanged(e) {
		this._cdItemTagForEntity(this.entity, true).code = e.detail.value;

        e.detail.value === "allergy" ? this.set("searchAllergen", true) : this.set("searchAllergen", false)
		e.detail.value === "adr" ? this.set("searchDrug", true) : this.set("searchDrug", false)
		e.detail.value === "familyrisk" ? this.set("searchFamilyLink", true) : this.set("searchFamilyLink", false)
		e.detail.value === "surgery" ? this.set("searchSurgery", true) :  this.set("searchSurgery", false)
	}

	_statusChanged(e) {
		switch (e.detail.value) {
			// case 'active': //will never be hit !
			// 	this.set('entity.closingDate', null);
			// 	((this.entity.status || 0) & 1) === 1 && this.set('entity.status', (this.entity.status || 0) - 1);
			// 	((this.entity.status || 0) & 2) === 1 && this.set('entity.status', (this.entity.status || 0) - 2);
			// 	break;
			case 'active-relevant': //set status to x00
				this.set('entity.closingDate', null);
				this.set('entity.status', (this.entity.status & 4 || 0));
				break;
			case 'active-irrelevant': //set status to x10
				this.set('entity.closingDate', null);
				this.set('entity.status', (this.entity.status & 4 || 0) | 2);
				break;
			case 'inactive': //set status to x01
				this.set('entity.status', (this.entity.status & 4 || 0) | 1);
				break;
			case 'archived': //set status to x11
				this.set('entity.status', (this.entity.status & 4 || 0) | 3);
				break;
		}
		console.log('status : ', this.entity.status)
	}

    _severityChanged(e) {
        this._tagForEntity(this.entity, 'CD-SEVERITY', 'normal').code = e.detail.value
    }

    _extraTemporalityChanged(e) {
        this._tagForEntity(this.entity, 'CD-EXTRA-TEMPORALITY', 'oneshot').code = e.detail.value
	}

    _certaintyChanged(e) {
        this._tagForEntity(this.entity, 'CD-CERTAINTY', 'probable').code = e.detail.value
	}

    _cellContent(item, column) {
		return _.isFunction(column.key) ? column.key(item) : _.get(item, column.key);
	}

	_key(column) {
		return _.isFunction(column.key) ? column.sortKey : column.key;
	}

	_label(language) {
		return `type:label.${['fr', 'nl'].includes(language) ? language : 'fr'}`;
	}

	click(e) {
		const selected = this.activeItem;

		console.log('selected ' + selected + ' - ' + this.latestSelected);
		if (this.inDoubleClick && (this.latestSelected === selected || this.latestSelected && !selected || !this.latestSelected && selected)) {
			this.select(this.latestSelected || selected);
		} else {
			this.latestSelected = selected;
			this.inDoubleClick = true;
			this.set('entity', _.assign(_.assign({}, this.entity || {}), selected));
			setTimeout(() => {
				delete this.inDoubleClick;
			}, 500);
		}
	}

	refresh() {
		//Give the gui the time to update the field
		setTimeout(function () {
			let currentValue = this.filterValue;

			if (this.latestSearchValue === currentValue) {
				return;
			}
			setTimeout(function () {
				if (currentValue === this.filterValue) {
					console.log("Triggering search for " + this.filterValue);
					this.$['entities-list'].clearCache();
				} else {
					console.log("Skipping search for " + this.filterValue + " != " + currentValue);
				}
			}.bind(this), 500); //Wait for the user to stop typing
		}.bind(this), 100);
	}

	confirm() {
		if (this.entity || this.activeItem) {
			console.log(this.entity)
			this.select(this.entity || this.activeItem);
		}
	}

	select(item) {
		if (item) {
			this.dispatchEvent(new CustomEvent('entity-selected', { detail: item, composed: true }));
			this.$.dialog.close();
		}
	}

	open() {
		this.flushComboData()
		this.set("isValid",false)
        this.api.code().findPaginatedCodes('be', 'CD-TEMPORALITY', '')
			.then(c => this.set("temporalityList", c.rows.filter(c => c.code === "acute" || c.code === "subacute" || c.code === "chronic")))
			.finally(() => {
				this.$.dialog.open();
				this.$.dialog.scrollTop = 0;

				const type = this.entity.tags.find(t => t.type === "CD-ITEM")
				type && type.code === "allergy" ? this.set("searchAllergen", true) : this.set("searchAllergen", false)
                type && type.code === "familyrisk" ? this.set("searchFamilyLink", true) : this.set("searchFamilyLink", false)
				type && type.code === "dra" ? this.set("searchDrug", true) : this.set("searchDrug", false)
                type && type.code === "surgery" ? this.set("searchSurgery", true) :  this.set("searchSurgery", false)

				this.dispatchEvent(new CustomEvent('open-health-problem', { bubbles: true, composed: true, detail: {entity: this.entity}}));
				this._checkValidity();
			})

	}

	flushComboData(){
        this.set('filterValue','')
        this.set('selectedItem',null)
        this.set('allergenFilterValue', '')
        this.set('allergenSelectedItem', null)
		this.set('drugFilterValue', '')
		this.set('drugSelectedItem', null)
        this.set('familyLinkFilterValue', '')
        this.set('familyRiskSelectedItem', null)
        this.set('surgeryFilterValue', '')
        this.set('surgerySelectedItem', null)
	}

	_closingDateChanged(date) {
		const dateString = date && this.api.moment(date).format('YYYY-MM-DD') || '';
		if (dateString !== this._openingDateAsString) {
			this.set('_closingDateAsString', dateString);
		}
	}

	_openingDateChanged(date) {
		const dateString = date && this.api.moment(date).format('YYYY-MM-DD') || '';
		if (dateString !== this._openingDateAsString) {
			this.set('_openingDateAsString', dateString);
		}
	}

	_ehDateChanged(startingDate, closingDate){

	    if(startingDate){
	        let startingDateAsString = this.api.moment(startingDate).format('YYYY-MM-DD') || ''
	        let closingDateAsString = closingDate ? this.api.moment(closingDate).format('YYYY-MM-DD') : closingDate = moment().format("YYYY-MM-DD")

            this._isChronical(startingDateAsString, closingDateAsString) === true ? this.set("temporalityItemIdx", this.temporalityList.indexOf(this.temporalityList.find(c => c.code === "chronic"))) :
                this._isSubAcute(startingDateAsString, closingDateAsString) === true ? this.set("temporalityItemIdx", this.temporalityList.indexOf(this.temporalityList.find(c => c.code === "subacute"))) :
                    this._isAcute(startingDateAsString, closingDateAsString) === true ? this.set("temporalityItemIdx", this.temporalityList.indexOf(this.temporalityList.find(c => c.code === "acute"))) :
						console.log("bug")
		}
	}

	_isChronical(start, end){
        return moment(start).isSameOrBefore(moment(end).subtract(6, "month"))
	}

	_isSubAcute(start, end){
       return moment(start).isBetween(moment(end).subtract(6, "month"), moment(end).subtract(1, "month"))
	}

	_isAcute(start, end){
        return moment(start).isSameOrAfter(moment(end).subtract(1, "month"))
	}

	_closingDateAsStringChanged(dateAsString) {
		if (!dateAsString) {
			this.entity && this.set('entity.closingDate', null);return;
		}
		const date = parseInt(dateAsString.replace(/(....)-(..)-(..)/, '$1$2$3')) * (this.displayTime ? 1000000 : 1);
		if (date !== this.value) {
			this.entity && this.set('entity.closingDate', date);
		}
	}

	_openingDateAsStringChanged(dateAsString) {
		if (!dateAsString) {
			this.entity && this.set('entity.openingDate', null);return;
		}
		const date = parseInt(dateAsString.replace(/(....)-(..)-(..)/, '$1$2$3')) * (this.displayTime ? 1000000 : 1);
		if (date !== this.value) {
			this.entity && this.set('entity.openingDate', date);
		}
	}

    _selectedTemporalityItemChanged(item){
        if(item && item.id && this.entity){
            const selectedItem = this.temporalityList.find(c => c.code === item.id)

            if(this.entity.tags.find(t => t.type === "CD-TEMPORALITY")){
                this.entity.tags.splice(this.entity.tags.indexOf(this.entity.tags.find(t => t.type === "CD-TEMPORALITY")), 1);
                this.entity.tags.push(selectedItem);
            }else{
                this.entity.tags.push(selectedItem);
            }

            console.log(this.entity.tags)


		}
	}

    _getTpLabel(item){
	    return item.label[this.language] ? item.label[this.language] : item.label.en
	}

    _checkValidity(){
	    if(this.entity.codes){
	        this.set("isValid",true)
		}
		else{
            this.set("isValid",false)
        }
	}

}

customElements.define(HealthProblemSelector.is, HealthProblemSelector);
</script>
</dom-module>
